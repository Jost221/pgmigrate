#pgmigrate  
  
CLI-—É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ **PostgreSQL ‚Üí PostgreSQL** –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º—ã.  
  
–ü–æ–¥—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:  
  
- –ø–µ—Ä–µ–ª–∏—Ç—å –æ–¥–Ω—É –ë–î –≤ –¥—Ä—É–≥—É—é (—Å—Ç–µ–Ω–¥, –∫–ª–∞—Å—Ç–µ—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ);  
- –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Å—Ö–µ–º/—Ç–∞–±–ª–∏—Ü;  
- –¥–µ–ª–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é **–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–π** (—á–µ—Ä–µ–∑ –ø–ª–∞–Ω) –∏ **–≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–æ–π** (—á–µ—Ä–µ–∑ state);  
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö.  
  
---  
  
## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏  
  
- üîπ **–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏** (`plan.tsv`) —Å —è–≤–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏:  
    - ROLE, SCHEMA_PRE, DATA (–ø–æ —Ç–∞–±–ª–∏—Ü–∞–º/—á–∞–Ω–∫–∞–º), SCHEMA_POST.  
- üîπ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** —á–µ—Ä–µ–∑ `GNU parallel` –∏ `COPY`.  
- üîπ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ resume**:  
    - —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è `state.tsv` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `DONE`/`FAILED` –¥–ª—è –∑–∞–¥–∞—á;  
    - –ø—Ä–∏ `--resume` DONE-–∑–∞–¥–∞—á–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.  
- üîπ **–ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö —Å—Ö–µ–º/—Ç–∞–±–ª–∏—Ü**:  
    - —Ä–µ–∂–∏–º—ã `all/include/exclude` –¥–ª—è —Å—Ö–µ–º –∏ —Ç–∞–±–ª–∏—Ü.  
- üîπ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è ‚Äú—Ç–æ–ª—Å—Ç—ã—Ö‚Äù —Ç–∞–±–ª–∏—Ü**:  
    - `chunk_column`, `chunk_size`, `where`, `order_by`, `limit` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–∞–º–∏ –∏ –æ–±—ä—ë–º–æ–º –¥–∞–Ω–Ω—ã—Ö.  
- üîπ **–ë—ç–∫–∞–ø target –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π** (`--backup`):  
    - –ø–æ–ª–Ω—ã–π `pg_dump -Fc` —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã –≤ —Ñ–∞–π–ª.  
- üîπ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π post-data**:  
    - –∏–Ω–¥–µ–∫—Å—ã, constraints, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –ø—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤.  
- üîπ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å**:  
    - –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è DATA-–∑–∞–¥–∞—á;  
    - summary –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–≤—Ä–µ–º—è, DONE/FAILED).  
  
---  
  
## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è  
  
- –û–°: **Ubuntu 20.04**  
- PostgreSQL: **—Å–µ—Ä–≤–µ—Ä 15+**, –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã `pg_dump`, `pg_dumpall`, `psql`  
- –£—Ç–∏–ª–∏—Ç—ã:  
    - [`yq` (mikefarah, v4+)](https://github.com/mikefarah/yq) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å –ø–æ–¥–∫–æ–º–∞–Ω–¥–æ–π `eval`  
    - [`GNU parallel`](https://www.gnu.org/software/parallel/)  
- –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:  
    - –Ω–∞ source: SELECT –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü, –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–∞–º;  
    - –Ω–∞ target: —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º/—Ç–∞–±–ª–∏—Ü/–∏–Ω–¥–µ–∫—Å–æ–≤/–∫–æ–Ω—Å—Ç—Ä–µ–π–Ω—Ç–æ–≤/—Ä–æ–ª–µ–π (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏).  
  
---  
  
## –£—Å—Ç–∞–Ω–æ–≤–∫–∞  
  
```bash  
git clone https://github.com/<your-org>/pgmigrate.git  
cd pgmigrate  
  
# —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ  
chmod +x pgmigrate.sh  
chmod +x lib/*.sh  
```  
  
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:  
  
```bash  
psql --version  
yq --version  
parallel --version  
```  
  
---  
  
## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç  
  
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞:  
  
¬†¬†```bash  
¬†¬†cp config.example.yaml config.yaml  
¬†¬†```  
  
2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `config.yaml` –ø–æ–¥ —Å–≤–æ–π —Å—Ç–µ–Ω–¥ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, —Å—Ö–µ–º—ã, —Ç–∞–±–ª–∏—Ü—ã).  
  
3. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏:  
  
¬†¬†```bash  
¬†¬†./pgmigrate.sh plan --config ./config.yaml  
¬†¬†```  
  
¬†¬†–í —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è `plan.tsv` –∏ –∫—Ä–∞—Ç–∫–∏–π summary.  
  
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:  
  
¬†¬†```bash  
¬†¬†./pgmigrate.sh migrate --config ./config.yaml  
¬†¬†```  
  
¬†¬†–ü–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è/–æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è `state.tsv`.  
  
---  
  
## CLI  
  
```bash  
./pgmigrate.sh migrate --config config.yaml ¬†¬†[--plan plan.tsv] ¬†¬†[--state state.tsv] ¬†¬†[--jobs N] ¬†¬†[--dry-run] ¬†¬†[--resume] ¬†¬†[--backup] ¬†¬†[--verbose]  
  
./pgmigrate.sh plan --config config.yaml ¬†¬†[--plan plan.tsv]  
```  
  
### –ê—Ä–≥—É–º–µ–Ω—Ç—ã  
  
- `migrate / plan` ‚Äî —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:  
    - `plan` ¬†‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞;  
    - `migrate` ‚Äî –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è.  
- `--config` / `-c` ‚Äî –ø—É—Ç—å –∫ YAML-–∫–æ–Ω—Ñ–∏–≥—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).  
- `--plan` ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ø–ª–∞–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `plan.tsv`).  
- `--state` ‚Äî –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `state.tsv`).  
- `--jobs` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (–ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç `parallel.max_jobs` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞).  
- `--dry-run` ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω –∏ summary **–±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö**.  
- `--resume` ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:  
    - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `plan.tsv` –∏ `state.tsv`;  
    - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `DONE`.  
- `--backup` ‚Äî –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π —Å–¥–µ–ª–∞—Ç—å **–ø–æ–ª–Ω—ã–π –ª–æ–≥–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø** target-–ë–î (`pg_dump -Fc`):  
    - ‚ö† –¥–ª—è –±–æ–ª—å—à–∏—Ö –ë–î —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å **–æ—á–µ–Ω—å –¥–æ–ª–≥–æ** –∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ.  
- `--verbose` ‚Äî –≤—ã–≤–æ–¥–∏—Ç—å INFO/WARN –≤ stdout; –±–µ–∑ –Ω–µ–≥–æ –≤ –∫–æ–Ω—Å–æ–ª—å –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ ERROR + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤–µ—Å—å –ª–æ–≥ –≤—Å–µ–≥–¥–∞ –ø–∏—à–µ—Ç—Å—è –≤ `pgmigrate.log`).  
  
---  
  
## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.yaml`)  
  
–ü–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä –ª–µ–∂–∏—Ç –≤ `config.example.yaml`. –ù–∏–∂–µ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∫—Ä–∞—Ç–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.  
  
```yaml  
source:  
¬†conninfo: "host=localhost port=5432 dbname=demo_airlines user=user1 password=pass1"  
  
target:  
¬†conninfo: "host=localhost port=5433 dbname=demo_airlines_migrated user=user2 password=pass2"  
  
schemas:  
¬†mode: include ¬†¬†¬†¬†¬†¬†¬†# all | include | exclude  
¬†include:  
¬†¬†¬†- bookings  
¬†exclude: []  
  
roles:  
¬†mode: all ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†# all | none  
  
tables:  
¬†mode: include ¬†¬†¬†¬†¬†¬†¬†# all | include | exclude  
  
¬†default:  
¬†¬†¬†chunk_column: "" ¬†¬†# "" = –Ω–µ —Ä–µ–∑–∞—Ç—å; –∏–Ω–∞—á–µ –∏–º—è int-–∫–æ–ª–æ–Ω–∫–∏  
¬†¬†¬†chunk_size: 500000  
¬†¬†¬†where: "" ¬†¬†¬†¬†¬†¬†¬†¬†¬†# –¥–æ–ø. WHERE –Ω–∞ source  
¬†¬†¬†order_by: "" ¬†¬†¬†¬†¬†¬†# ORDER BY –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö  
¬†¬†¬†limit: 0 ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†# 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞; >0 = LIMIT –¥–ª—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã  
  
¬†include:  
¬†¬†¬†- schema: "bookings"  
¬†¬†¬†¬†¬†name: ¬†¬†"flights"  
¬†¬†¬†¬†¬†chunk_column: "flight_id"  
¬†¬†¬†¬†¬†chunk_size: 100000  
¬†¬†¬†¬†¬†where: ""  
¬†¬†¬†¬†¬†order_by: "flight_id"  
¬†¬†¬†¬†¬†limit: 0  
  
¬†¬†¬†- schema: "bookings"  
¬†¬†¬†¬†¬†name: ¬†¬†"ticket_flights"  
¬†¬†¬†¬†¬†chunk_column: "flight_id"  
¬†¬†¬†¬†¬†chunk_size: 300000  
¬†¬†¬†¬†¬†where: ""  
¬†¬†¬†¬†¬†order_by: "flight_id"  
¬†¬†¬†¬†¬†limit: 100 ¬†¬†¬†# –ø—Ä–∏–º–µ—Ä: –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 100 —Å—Ç—Ä–æ–∫ (–¥–ª—è —Ç–µ—Å—Ç–∞)  
  
¬†exclude: []  
  
parallel:  
¬†max_jobs: 4 ¬†¬†¬†¬†¬†¬†¬†¬†¬†# –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ–¥–µ–ª –ø–æ—Ç–æ–∫–æ–≤ (—Ñ–∞–∫—Ç. = min(max_jobs, 80% CPU))  
  
options:  
¬†create_indexes_after_data: true  
¬†create_constraints_after_data: false  
¬†analyze_after_load: true  
```  
  
### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `tables.mode`  
  
- `mode: all` ¬†¬†  
¬†–ë–µ—Ä—ë–º **–≤—Å–µ** —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º (–∫—Ä–æ–º–µ `tables.exclude`). ¬†¬†  
¬†`tables.include` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è **—Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (—á–∞–Ω–∫–∏, where, limit) –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º.  
  
- `mode: include` ¬†¬†  
¬†–ú–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —Ç–∞–±–ª–∏—Ü—ã, –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ –≤ `tables.include`.  
  
- `mode: exclude` ¬†¬†  
¬†–ú–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º, **–∫—Ä–æ–º–µ** `tables.exclude`.  
  
### –ß–∞–Ω–∫–∏ –∏ –ª–∏–º–∏—Ç—ã  
  
- `chunk_column` + `chunk_size`:  
    - –µ—Å–ª–∏ `chunk_column` –ø—É—Å—Ç–æ–π ‚Üí —Ç–∞–±–ª–∏—Ü–∞ –º–∏–≥—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ–π `DATA`;  
    - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω int-—Å—Ç–æ–ª–±–µ—Ü ‚Üí –ø–ª–∞–Ω–µ—Ä —Å—á–∏—Ç–∞–µ—Ç `MIN/MAX/COUNT` –∏ —Ä–µ–∂–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —á–∞–Ω–∫–∏.  
  
- `limit`:  
    - –µ—Å–ª–∏ `limit > 0` –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã ‚Üí **—á–∞–Ω–∫–∏ –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è**, —Å–æ–∑–¥–∞—ë—Ç—Å—è **–æ–¥–Ω–∞** –∑–∞–¥–∞—á–∞ —Å `LIMIT <limit>`;  
    - —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–≥–æ–Ω–æ–≤ –Ω–∞ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö.  
  
---  
  
## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è  
  
### –≠—Ç–∞–ø—ã  
  
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**:  
    - OS = Ubuntu 20.04;  
    - –Ω–∞–ª–∏—á–∏–µ `psql`, `pg_dump`, `pg_dumpall`, `yq`, `parallel`;  
    - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π PostgreSQL (source/target ‚â• 15).  
  
2. **–ß—Ç–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** (`config.yaml`):  
    - conninfo –¥–ª—è source/target;  
    - —Ä–µ–∂–∏–º—ã `schemas`/`tables`/`roles`;  
    - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞–Ω–∫–æ–≤ –∏ –ª–∏–º–∏—Ç–æ–≤.  
  
3. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞** (`plan.tsv`):  
    - —Ä–æ–ª–∏ (`ROLE`);  
    - pre-data (`SCHEMA_PRE`);  
    - DATA-–∑–∞–¥–∞—á–∏ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º/—á–∞–Ω–∫–∞–º (—Å `where`/`order_by`/`limit`);  
    - post-data (`SCHEMA_POST`).  
  
4. **(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ë—ç–∫–∞–ø target-–ë–î** (`--backup`):  
    - `pg_dump -Fc` —Ü–µ–ª–µ–≤–æ–π –±–∞–∑—ã –≤ —Ñ–∞–π–ª `./backup/pgmigrate_backup_<dbname>_<timestamp>.dump`;  
    - –ø—Ä–∏ –æ—à–∏–±–∫–µ –±—ç–∫–∞–ø–∞ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.  
  
5. **–ü–µ—Ä–µ–Ω–æ—Å —Ä–æ–ª–µ–π** (–µ—Å–ª–∏ `roles.mode: all`):  
    - `pg_dumpall --roles-only` –Ω–∞ source;  
    - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ target (–æ—à–∏–±–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–æ–ª–µ–π –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω—ã).  
  
6. **Pre-data (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)**:  
    - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º –Ω–∞ target (`CREATE SCHEMA IF NOT EXISTS ...`);  
    - `pg_dump --schema-only --section=pre-data` –¥–ª—è —Ç–∞–±–ª–∏—Ü, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç –Ω–∞ target.  
  
7. **DATA-–∑–∞–¥–∞—á–∏ (–¥–∞–Ω–Ω—ã–µ)**:  
    - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –≤–∏–¥–∞:  
¬†¬†¬†¬†```sql  
¬†¬†¬†¬†COPY (  
¬†¬†¬†¬†¬†¬†SELECT * FROM "schema"."table"  
¬†¬†¬†¬†¬†¬†[WHERE ...]  
¬†¬†¬†¬†¬†¬†[ORDER BY ...]  
¬†¬†¬†¬†¬†¬†[LIMIT ...]  
¬†¬†¬†¬†) TO STDOUT;  
¬†¬†¬†¬†```  
    - –ø–µ—Ä–µ–¥–∞—á–∞ –≤ target —á–µ—Ä–µ–∑ `psql ... COPY ... FROM STDIN`;  
    - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ —á–µ—Ä–µ–∑ `GNU parallel`;  
    - –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç—É—Å–∞ –≤ `state.tsv`: `<task_id> ¬†¬†DONE` –∏–ª–∏ `<task_id> ¬†¬†¬†FAILED`.  
  
8. **Post-data (–∏–Ω–¥–µ–∫—Å—ã, constraints, —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø—Ä–∞–≤–∞)**:  
    - –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã: `pg_dump --schema-only --section=post-data --table=schema.table`;  
    - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ target –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤.  
  
9. **ANALYZE** (–µ—Å–ª–∏ `analyze_after_load: true`):  
    - –¥–ª—è –≤—Å–µ—Ö –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: `ANALYZE "schema"."table";`.  
  
10. **Summary**:  
    - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã;  
    - —á–∏—Å–ª–æ DATA-–∑–∞–¥–∞—á –ø–æ –ø–ª–∞–Ω—É;  
    - DONE/FAILED –ø–æ `state.tsv`.  
  
---  
  
## Resume –∏ `state.tsv`  
  
–§–∞–π–ª `state.tsv` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞:  
  
```text  
<task_id> ¬†¬†¬†¬†¬†¬†DONE  
<task_id> ¬†¬†¬†¬†¬†¬†FAILED  
```  
  
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å `--resume`:  
  
- –ø–ª–∞–Ω (`plan.tsv`) **–Ω–µ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π;  
- DATA-–∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `DONE` –≤ `state.tsv` **–ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è**;  
- –∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `FAILED` –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ.  
  
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:  
  
- –¥–æ–∫–∞—á–∏–≤–∞—Ç—å —É–ø–∞–≤—à–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏;  
- –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–µ—Ä–µ–ª–∏–≤–∞ —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.  
  
---  
  
## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
  
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è (`INFO/WARN/ERROR`) –≤—Å–µ–≥–¥–∞ –ø–∏—à—É—Ç—Å—è –≤ —Ñ–∞–π–ª `pgmigrate.log`.  
- –í –∫–æ–Ω—Å–æ–ª—å:  
    - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–æ–ª—å–∫–æ `ERROR` + –ø—Ä–æ–≥—Ä–µ—Å—Å;  
    - –ø—Ä–∏ `--verbose` ‚Äî —Ç–∞–∫–∂–µ `INFO`/`WARN`.  
  
---  
  
## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∑–∞–º–µ—á–∞–Ω–∏—è  
  
- –û—Ä–∏–µ–Ω—Ç–∏—Ä –Ω–∞ Ubuntu 20.04 + PostgreSQL 15+ (—Ö–æ—Ç—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –≤ –¥—Ä—É–≥–∏—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö, –Ω–æ —ç—Ç–æ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ).  
- –ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ ‚Äú–ª–∏–º–∏—Ç–∞ –ø–æ –≤—Å–µ–π –ë–î‚Äù —Å–µ–π—á–∞—Å –Ω–µ—Ç ‚Äî –ª–∏–º–∏—Ç—ã –∑–∞–¥–∞—é—Ç—Å—è **–≤ –∫–∞–¥–∂–æ–π —Ç–∞–±–ª–∏—Ü–µ –æ—Ç–¥–µ–ª—å–Ω–æ** —á–µ—Ä–µ–∑ `limit`.  
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞–º–∏/–∫–æ–Ω—Å—Ç—Ä–µ–π–Ω—Ç–∞–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–æ –≤ post-data:  
¬†- –æ—à–∏–±–∫–∏ –≤—Ä–æ–¥–µ ‚Äúindex already exists‚Äù –≤ resume-—Ä–µ–∂–∏–º–µ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ñ–∞—Ç–∞–ª—å–Ω—ã–º–∏.  
  
---  
